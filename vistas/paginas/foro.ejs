<h2>Foro del Evento</h2>

<!-- Formulario único para publicar un mensaje -->
<form action="/foro/agregar" method="POST">
    <input type="hidden" name="id" value="<%= evento_id %>">
    <textarea name="mensaje" required placeholder="Escribe tu mensaje aquí..."></textarea>
    <button type="submit">Publicar mensaje</button>
</form>

<hr>

<div class="mensajes">
    <% function renderMensajes(mensajes, parentId = null, nivel = 0) { %>
        <% mensajes
            .filter(m => m.parent_id === parentId)  <!-- Filtra los mensajes que pertenecen al parentId actual -->
            .forEach(m => { %>
                <div>
                    <p><strong><%= m.usuario %></strong> <em><%= m.fecha %></em></p>
                    <p><%= m.contenido %></p>

                    <!-- Si es un mensaje principal, permite responder a este mensaje -->
                    <% if (parentId === null) { %>
                        <form action="/foro/agregar" method="POST">
                            <input type="hidden" name="id" value="<%= evento_id %>">
                            <input type="hidden" name="parent_id" value="<%= m.id %>"> <!-- Aquí se envía el parent_id -->
                            <textarea name="mensaje" required placeholder="Escribe tu respuesta aquí..."></textarea>
                            <button type="submit">Responder</button>
                        </form>
                    <% } %>

                    <!-- Llamada recursiva para mostrar respuestas -->
                    <% renderMensajes(mensajes, m.id, nivel + 1); %>
                </div>
        <% }); %>
    <% } %>

    <!-- Renderiza los mensajes principales (no respuestas) -->
    <% renderMensajes(mensajes); %>
</div>
